name: Deploy Next.js + Express App

on:
  push:
    branches: [main]  # Trigger on push to main

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]  # Correct label set from your registered runner

    steps:
      - name: Print Docker Compose Version
        run: docker-compose --version

      - name: Deploy App from Project Directory
        run: |
          echo "ğŸ” Navigating to project directory"
          cd /home/docker/nextjs-express

          echo "ğŸ“¦ Fetching latest code"
          git reset --hard
          git clean -fd
          git fetch origin
          git checkout main
          git pull origin main

          echo "ğŸ³ Building and starting containers"
          docker-compose up -d --build

          echo "ğŸ§¹ Pruning old images"
          docker image prune -f

          echo "âœ… Deployment complete. Running containers:"
          docker ps
